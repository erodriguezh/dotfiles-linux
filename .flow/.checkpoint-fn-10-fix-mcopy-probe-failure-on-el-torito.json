{
  "created_at": "2026-02-18T19:50:11.374841Z",
  "epic": {
    "data": {
      "branch_name": "feature/fn-10-fix-mcopy-probe-failure-on-el-torito",
      "completion_review_status": "unknown",
      "completion_reviewed_at": null,
      "created_at": "2026-02-18T19:47:40.817841Z",
      "default_impl": null,
      "default_review": null,
      "default_sync": null,
      "depends_on_epics": [
        "fn-9-extract-efibootimg-via-el-torito-when"
      ],
      "id": "fn-10-fix-mcopy-probe-failure-on-el-torito",
      "next_task": 1,
      "plan_review_status": "unknown",
      "plan_reviewed_at": null,
      "spec_path": ".flow/specs/fn-10-fix-mcopy-probe-failure-on-el-torito.md",
      "status": "open",
      "title": "Fix mcopy probe failure on El Torito-extracted EFI images",
      "updated_at": "2026-02-18T19:48:51.981392Z"
    },
    "spec": "# Fix mcopy probe failure on El Torito-extracted EFI images\n\n## Problem\n\nThe fn-9 El Torito extraction fallback succeeds \u2014 `osirrox -extract_boot_images` correctly extracts 6 files from the Fedora 43 boot.iso, including `eltorito_img2_uefi.img` (13 MB, clearly the EFI boot image). However, the mcopy probe at `iso/build-iso.sh:1010` fails to find `grub.cfg` in ANY extracted file:\n\n```\n[INFO]    El Torito images extracted via osirrox\n[ERROR] El Torito extraction produced no EFI boot image (no files contain grub.cfg)\n[ERROR]   Extracted files:\n[ERROR]     eltorito_img2_uefi.img (13225984 bytes)\n[ERROR]     gpt_part2_efi.img (13225984 bytes)\n```\n\nThe probe checks both `::/EFI/BOOT/grub.cfg` and `::/EFI/fedora/grub.cfg` but finds neither.\n\n## Root Cause\n\nThe El Torito-extracted image is likely NOT a raw FAT filesystem that mtools can read directly. Possible causes (need diagnostic verification):\n\n1. **Partition table wrapper** \u2014 The extracted image may have a GPT or MBR partition table wrapping the FAT filesystem. mtools expects the first sector to be a FAT boot sector, but instead finds a partition table header. This is the most likely cause for the `gpt_part2_efi.img` file (extracted from GPT), and may also affect `eltorito_img2_uefi.img` depending on how the El Torito entry references the data.\n\n2. **Alignment padding** \u2014 The extracted byte range may include leading padding/zeroes before the actual FAT boot sector.\n\n3. **Non-standard FAT format** \u2014 The image may use a FAT subtype that mtools doesn't recognize (unlikely given mtools maturity, but worth diagnosing).\n\n4. **Different directory structure** \u2014 grub.cfg may exist at a path not currently probed (unlikely given lorax always creates `EFI/BOOT/grub.cfg`, but worth verifying).\n\n## Solution\n\nAdd a partition-table-aware fallback to the El Torito mcopy probe. When direct mcopy fails, detect if the image has a partition table and extract the raw FAT partition with `dd` before re-probing.\n\n**Key design choice**: Strip the partition wrapper with `dd` to produce a clean raw FAT image, rather than using mtools `@@offset` syntax on every call. This is safer because:\n- ALL 5+ downstream mcopy calls in `patch_efiboot()` work unchanged\n- `_verify_inst_ks_efiboot()` (outside the function, at `iso/build-iso.sh:1726`) works unchanged\n- xorriso re-injection with `-update \"$efi_img\" /images/efiboot.img` gets a clean FAT image\n- Firmware compatibility is guaranteed (UEFI expects raw FAT for efiboot.img)\n\n**Fallback chain for El Torito image identification** (extends existing code at `iso/build-iso.sh:1003-1045`):\n\n1. **Direct mcopy probe** (existing) \u2014 try `mcopy -o -i \"$file\" ::/EFI/BOOT/grub.cfg /dev/null` and `::/EFI/fedora/grub.cfg`\n2. **NEW: Partition-stripped probe** \u2014 if direct probe finds zero candidates:\n   a. For each extracted file >1 MB: run `file` command, log result\n   b. If `file` reports partition table (MBR/GPT): use `sfdisk -d` to find EFI partition offset/size\n   c. Extract raw FAT partition with `dd bs=512 skip=$sector count=$size`\n   d. Re-probe the stripped image with mcopy for both grub.cfg paths\n3. Zero/multiple matches still cause hard-fail with diagnostics (unchanged)\n\n## Scope\n\nNarrow \u2014 El Torito probe logic in `patch_efiboot()` Step A + Containerfile tool dependency + README update.\n\n### Task 1: Add partition-aware El Torito probe fallback\n\n**File:** `iso/build-iso.sh` \u2014 `patch_efiboot()` Step A El Torito probe (~lines 1003-1045)\n**File:** `iso/Containerfile` \u2014 may need `util-linux` and/or `file` added to `dnf5 install`\n\nAfter the existing direct mcopy probe loop finds zero candidates, add:\n\n1. Log diagnostic: `file` output for each extracted image (always, even before fallback \u2014 helps debugging)\n2. For each file >1 MB that `file` identifies as having a partition table:\n   a. Run `sfdisk -d \"$file\"` to get partition layout\n   b. Find EFI System Partition entry (MBR type `0xEF` or GPT type GUID)\n   c. Extract sector offset and size\n   d. `dd bs=512 skip=$sector count=$size if=\"$file\" of=\"${work_dir}/stripped_fat.img\"`\n   e. Probe stripped image with mcopy for both grub.cfg paths\n3. If exactly one stripped image passes probe, copy it to `$efi_img`\n4. If multiple pass, hard-fail with diagnostics (same as existing)\n5. Capture and display mcopy stderr on final failure (instead of suppressing with `2>/dev/null`)\n\n**Fallback for missing sfdisk**: If `sfdisk` is not available, try `fdisk -l` parsing. If neither available, hard-fail with message recommending `util-linux` install.\n\n**Key context:**\n- `sfdisk -d` output format: `start=SECTOR, size=SECTOR, type=GUID_OR_ID`\n- EFI System Partition: MBR type `0xEF`, GPT GUID `C12A7328-F81F-11D2-BA4B-00A0C93EC93B`\n- `dd bs=512 skip=SECTOR count=SIZE` is efficient (512-byte sector alignment)\n- The resulting `$efi_img` must be a clean raw FAT image \u2014 all downstream Steps B-G and `_verify_inst_ks_efiboot()` depend on this\n- mtools `@@offset` syntax exists but using `dd` extraction is cleaner (avoids modifying 5+ mcopy call sites)\n- The `$work_dir` RETURN trap handles cleanup automatically\n\n### Task 2: Update iso/README.md for partition-wrapped EFI images\n\n**File:** `iso/README.md` \u2014 \"mkksiso fails with losetup / mkefiboot error\" section (~lines 221-224)\n\nUpdate the El Torito extraction description (step 1, bullet 3) to mention:\n- El Torito-extracted images may have a partition table wrapper (GPT/MBR) around the FAT filesystem\n- The probe automatically detects and strips the partition wrapper via `dd`\n- `file` diagnostic output is logged for debugging\n\n## Quick commands\n\n```bash\n# Build ISO \u2014 should complete Stage 11 including efiboot.img patching\npodman run --privileged --rm -v \"$PWD:/build\" \\\n  surface-iso-builder /build/iso/build-iso.sh --test\n\n# Diagnostic: inspect El Torito extracted images (run inside container)\nmkdir -p /tmp/et && osirrox -indev /build/.cache/isos/fedora-boot-43.iso -extract_boot_images /tmp/et/\nfor f in /tmp/et/*; do echo \"=== $(basename \"$f\") ===\"; file \"$f\"; done\n# Check if any files have partition tables\nfor f in /tmp/et/*; do sfdisk -d \"$f\" 2>/dev/null && echo \"  ^ has partition table\"; done\n```\n\n## Acceptance\n\n- [ ] mcopy probe succeeds on El Torito-extracted EFI images (both partition-wrapped and raw FAT)\n- [ ] `file` diagnostic logged for each extracted image (aids debugging future ISO format changes)\n- [ ] Partition table detected via `sfdisk` when present; raw FAT partition extracted with `dd`\n- [ ] `$efi_img` always contains clean raw FAT (no partition wrapper) \u2014 downstream Steps B-G unchanged\n- [ ] `_verify_inst_ks_efiboot()` works without modification (receives clean FAT)\n- [ ] Backward compatible \u2014 direct mcopy probe still tried first\n- [ ] mcopy stderr captured and displayed on final failure (not suppressed)\n- [ ] Full ISO build succeeds end-to-end in Podman with loop device probe failure\n- [ ] iso/README.md updated to mention partition-wrapper handling\n\n## Out of scope\n\n- Changing Steps B-G or `_verify_inst_ks_efiboot()` (the dd extraction makes this unnecessary)\n- Supporting images with multiple FAT partitions (hard-fail is correct)\n- Using mtools `@@offset` syntax (dd extraction is simpler and avoids modifying 5+ call sites)\n- Adding loop device support to the container\n\n## References\n\n- `iso/build-iso.sh:1003-1045` \u2014 El Torito mcopy probe loop (the failing code)\n- `iso/build-iso.sh:1058-1066` \u2014 Step B grub.cfg discovery (depends on clean FAT)\n- `iso/build-iso.sh:1076` \u2014 Step C mcopy extract (depends on clean FAT)\n- `iso/build-iso.sh:1236` \u2014 Step C mcopy write-back (depends on clean FAT)\n- `iso/build-iso.sh:1240` \u2014 Step D mcopy verify (depends on clean FAT)\n- `iso/build-iso.sh:1726` \u2014 `_verify_inst_ks_efiboot()` mcopy probe (outside patch_efiboot)\n- `iso/build-iso.sh:1332-1391` \u2014 Step E xorriso re-injection (needs clean FAT path)\n- `iso/README.md:221-224` \u2014 El Torito troubleshooting documentation\n- `iso/Containerfile` \u2014 Container build dependencies\n- [GNU mtools manual \u2014 @@offset syntax](https://www.gnu.org/software/mtools/manual/mtools.html)\n- [xorriso boot_sectors.txt](https://github.com/Distrotech/xorriso/blob/master/doc/boot_sectors.txt)\n- [lorax mkefiboot source](https://github.com/weldr/lorax/blob/master/src/bin/mkefiboot) \u2014 confirms efiboot.img is raw FAT\n"
  },
  "epic_id": "fn-10-fix-mcopy-probe-failure-on-el-torito",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-18T19:48:58.385645Z",
        "depends_on": [],
        "epic": "fn-10-fix-mcopy-probe-failure-on-el-torito",
        "id": "fn-10-fix-mcopy-probe-failure-on-el-torito.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-10-fix-mcopy-probe-failure-on-el-torito.1.md",
        "status": "todo",
        "title": "Add partition-aware El Torito probe with dd extraction and README update",
        "updated_at": "2026-02-18T19:49:25.933233Z"
      },
      "id": "fn-10-fix-mcopy-probe-failure-on-el-torito.1",
      "runtime": null,
      "spec": "# fn-10-fix-mcopy-probe-failure-on-el-torito.1 Add partition-aware El Torito probe with dd extraction and README update\n\n## Description\n\nAdd a partition-table-aware fallback to the El Torito mcopy probe in `patch_efiboot()` Step A. When direct mcopy fails on ALL extracted files, detect partition table wrappers (GPT/MBR) and extract the raw FAT partition with `dd` before re-probing.\n\n**Size:** M\n**Files:** `iso/build-iso.sh`, `iso/Containerfile` (if tools missing), `iso/README.md`\n\n### Approach\n\nExtend the El Torito probe loop at `iso/build-iso.sh:1003-1045`. After the existing direct mcopy probe finds zero candidates:\n\n1. **Add `file` diagnostic** \u2014 before the zero-match hard-fail, log `file` output for each extracted image. Follow existing log pattern: `info \"  $(basename \"$f\"): $(file -b \"$f\")\"`\n\n2. **Partition-stripped probe** \u2014 for each extracted file >1 MB (skip catalog/mbr/systemarea):\n   a. Run `sfdisk -d \"$file\" 2>/dev/null` to detect partition table\n   b. Parse output for EFI System Partition entry: MBR type `0xEF` (in `sfdisk` output as `type=ef` or `type=EF`) or GPT GUID `C12A7328-F81F-11D2-BA4B-00A0C93EC93B` (in `sfdisk` output as `type=C12A7328-...`)\n   c. Extract sector offset (`start=SECTOR`) and size (`size=SECTOR`)\n   d. `dd bs=512 skip=$sector count=$size if=\"$file\" of=\"${work_dir}/stripped_fat.img\" 2>/dev/null`\n   e. Probe stripped image with mcopy for both grub.cfg paths\n   f. If match found, add to candidates array (same pattern as existing code)\n\n3. **Exactly-one/zero/multiple match logic** \u2014 reuse existing logic at lines 1018-1044\n\n4. **Capture mcopy stderr** \u2014 on final failure (zero matches after both direct and stripped probes), capture and display mcopy stderr from at least one probe attempt for diagnostics (instead of suppressing all with `2>/dev/null`)\n\n5. **Ensure `sfdisk` availability** \u2014 check that `sfdisk` is available; if not, skip partition-stripped probe and fall through to existing hard-fail. If `util-linux` is NOT in the Containerfile's `dnf5 install`, add it.\n\n6. **Update iso/README.md** \u2014 in the El Torito bullet (line ~224), add a note that extracted images may have partition table wrappers and the probe automatically strips them.\n\n### Key context\n\n- `sfdisk -d \"$file\"` output format: `/dev/...: start=SECTOR, size=SECTOR, type=GUID_OR_HEX, ...`\n  For disk images (not block devices), the device field may be the filename\n- EFI System Partition identifiers: MBR type `0xEF`, GPT GUID `C12A7328-F81F-11D2-BA4B-00A0C93EC93B`\n- `dd bs=512 skip=SECTOR count=SIZE` extracts the raw FAT partition \u2014 efficient with 512-byte sector alignment\n- The resulting stripped file is a clean raw FAT image \u2014 ALL downstream mcopy calls (Steps B-G at lines 1058-1240) and `_verify_inst_ks_efiboot()` (line 1726) work unchanged\n- Do NOT use mtools `@@offset` syntax \u2014 `dd` extraction is cleaner (avoids modifying 5+ call sites)\n- The `$work_dir` RETURN trap at line 958 handles cleanup of temp files automatically\n- `file -b` gives brief output without filename prefix (cleaner for logging)\n- Follow existing stderr capture pattern from fn-8: `extract_err=\"$(command 2>&1)\"`\n- `sfdisk` exits non-zero on files without partition tables \u2014 this is expected, not an error\n\n## Acceptance\n\n- [ ] Direct mcopy probe still tried first (backward compatible)\n- [ ] `file` diagnostic logged for each extracted image before hard-fail\n- [ ] Partition table detected via `sfdisk` when present\n- [ ] Raw FAT partition extracted with `dd bs=512 skip=$sector count=$size`\n- [ ] Stripped image probed with mcopy for both grub.cfg paths (`::/EFI/BOOT/grub.cfg` and `::/EFI/fedora/grub.cfg`)\n- [ ] `$efi_img` always contains clean raw FAT \u2014 downstream Steps B-G unchanged\n- [ ] `_verify_inst_ks_efiboot()` works without modification (clean FAT propagated)\n- [ ] Zero match: hard-fail with `file` diagnostics + mcopy stderr (not suppressed)\n- [ ] Multiple match: hard-fail listing all candidates (existing behavior preserved)\n- [ ] Missing `sfdisk`: graceful degradation (skip partition probe, fall through to hard-fail)\n- [ ] `util-linux` and `file` available in Containerfile (add if missing)\n- [ ] iso/README.md updated to mention partition-wrapper detection\n- [ ] Full ISO build succeeds end-to-end in Podman with loop device probe failure\n\n## Done summary\n\n## Evidence\n"
    }
  ]
}
