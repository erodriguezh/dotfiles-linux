{
  "created_at": "2026-02-16T10:55:00.236080Z",
  "epic": {
    "data": {
      "branch_name": "fn-2-custom-offline-fedora-43-iso-builder",
      "completion_review_status": "unknown",
      "completion_reviewed_at": null,
      "created_at": "2026-02-16T08:55:07.881966Z",
      "default_impl": null,
      "default_review": null,
      "default_sync": null,
      "depends_on_epics": [
        "fn-1-surface-go-3-fedora-install-script"
      ],
      "id": "fn-2-custom-offline-fedora-43-iso-builder",
      "next_task": 1,
      "plan_review_status": "ship",
      "plan_reviewed_at": "2026-02-16T10:54:54.527116Z",
      "spec_path": ".flow/specs/fn-2-custom-offline-fedora-43-iso-builder.md",
      "status": "open",
      "title": "Custom offline Fedora 43 ISO builder",
      "updated_at": "2026-02-16T10:54:54.527409Z"
    },
    "spec": "# Custom Offline Fedora 43 ISO Builder\n\n## Overview\n\nBuild a custom, self-contained Fedora 43 ISO for the Surface Go 3 that produces a fully configured Hyprland desktop with a single boot + reboot \u2014 zero manual post-install steps, zero network required during install. Inspired by [Omarchy's ISO builder](https://github.com/omacom-io/omarchy-iso) but adapted for Fedora's kickstart ecosystem.\n\n**Current flow:** Download stock Fedora Everything ISO \u2192 edit kickstart placeholders \u2192 boot with OEMDRV \u2192 Anaconda installs Minimal \u2192 reboot \u2192 manually run `./install.sh` \u2192 reboot \u2192 done (3 boots, manual steps, needs WiFi).\n\n**New flow:** Run `./iso/build-iso.sh --username=X --password-hash-file=./hash.txt` \u2192 produces `surface-linux-F43-YYYYMMDD.iso` \u2192 flash to USB \u2192 boot Surface Go 3 \u2192 Anaconda installs everything from embedded local repo (offline) \u2192 reboot \u2192 fully configured Hyprland desktop (2 boots, zero manual steps, zero network).\n\n## Scope\n\n**In scope:**\n- `iso/` directory: build script, Containerfile, ISO-specific kickstart\n- GitHub Actions workflow for CI validation + ISO artifact production\n- Offline package repo (official Fedora + 3 COPRs + linux-surface)\n- Pre-downloaded assets (binaries, fonts, lazy.nvim)\n- Theme generation during build\n- README restructuring for two install paths\n\n**Out of scope:**\n- Modifying existing `install.sh` or `lib/*.sh` stages\n- Custom package repository infrastructure (no pkgs.omarchy.org equivalent)\n- Nightly automated builds (manual dispatch only)\n- LUKS encryption (matches current design)\n- Secure Boot key enrollment during ISO install\n\n## Approach\n\n### Architecture: mkksiso + offline repo\n\n```\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 BUILD (Podman container, Fedora 43)                      \u2502\n\u2502                                                          \u2502\n\u2502 1. Enable repos: official + 3 COPRs + linux-surface      \u2502\n\u2502 2. Expand @^minimal-environment \u2192 package list           \u2502\n\u2502 3. dnf5 download --resolve --destdir \u2192 local RPM cache   \u2502\n\u2502 4. createrepo_c \u2192 local repo with metadata               \u2502\n\u2502 5. repoclosure validation \u2192 verify self-contained repo   \u2502\n\u2502 6. Download: impala, bluetui, starship, JetBrains Mono   \u2502\n\u2502    (impala/bluetui kept as TUIs; Waybar uses nmtui)      \u2502\n\u2502 7. git clone lazy.nvim (stable branch)                   \u2502\n\u2502 8. Copy surface-linux repo + generate theme files        \u2502\n\u2502 9. Substitute credentials in kickstart template          \u2502\n\u2502 10. mkksiso: embed ks + repo + assets \u2192 boot.iso         \u2502\n\u2502                                                          \u2502\n\u2502 Output: surface-linux-F43-YYYYMMDD-x86_64.iso (~1.5 GB)  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                          \u2502\n                          \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 INSTALL (Surface Go 3, fully offline)                    \u2502\n\u2502                                                          \u2502\n\u2502 1. Boot from USB                                         \u2502\n\u2502 2. Anaconda auto-loads embedded kickstart (inst.ks=cdrom)\u2502\n\u2502 3. Partitions eMMC (EFI + /boot + ext4 root, no swap)   \u2502\n\u2502 4. Installs ALL packages from embedded local repo        \u2502\n\u2502 5. %post --nochroot: copies repo, binaries, fonts,       \u2502\n\u2502    lazy.nvim to installed system                         \u2502\n\u2502 6. %post (chroot): zram, network, getty, XDG portals,    \u2502\n\u2502    UWSM env, dotfile symlinks, services, tuned profile   \u2502\n\u2502 7. Reboot \u2192 Hyprland desktop, fully configured           \u2502\n\u2502                                                          \u2502\n\u2502 First nvim launch: lazy.nvim auto-syncs plugins (WiFi)   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n```\n\n### Key design decisions\n\n| Decision | Choice | Rationale |\n|----------|--------|-----------|\n| Base ISO | Fedora boot.iso (~800 MB) | Smallest Anaconda base; all packages from embedded repo |\n| Build tool | mkksiso (from lorax) | Embeds kickstart + files into existing ISO; simpler than livemedia-creator |\n| Credentials | Build-time injection via `--password-hash-file` or `ISO_PASSWORD_HASH` env var | Issue #14: %pre interactive prompts fail in Anaconda. File/env avoids shell history leaks |\n| Package install | All in kickstart `%packages` | Anaconda handles dependency resolution from embedded repo |\n| Config stages | kickstart `%post` (chroot) | Pure file ops + `systemctl enable` (creates symlinks, no running systemd needed) |\n| Neovim plugins | Pre-clone lazy.nvim; defer plugin sync | First nvim launch auto-syncs (needs WiFi); matches Omarchy approach |\n| install.sh | Unchanged, kept as manual path | ISO = alternative path, not replacement |\n| ISO size target | <2 GiB | Fits GitHub Release asset limit; boot.iso + packages \u2248 1.3-1.8 GB |\n\n### mkksiso contract (critical details)\n\nmkksiso embeds files into the existing Fedora boot.iso. The exact in-ISO paths:\n\n- `mkksiso --ks /tmp/kickstart.ks` \u2192 embeds as `/ks.cfg` at ISO root\n- `-a <local-repo-dir>:/local-repo` \u2192 RPM repo appears as `/local-repo` at ISO root\n- `-a <assets-dir>:/iso-assets` \u2192 assets appear as `/iso-assets` at ISO root\n- `-a <repo-dir>:/surface-linux` \u2192 dotfiles repo appears as `/surface-linux` at ISO root\n- `-c \"inst.ks=cdrom:/ks.cfg\"` \u2192 boot cmdline tells Anaconda to load ks from the ISO itself (NOT `file:///` which refers to initrd filesystem)\n- `-V \"SurfaceLinux-43\"` \u2192 volume label\n\nNote: If mkksiso on Fedora 43 does not support `-a SRC:DEST` mapping syntax, use a fallback: copy directories to temp paths with the desired names (`/tmp/local-repo`, `/tmp/iso-assets`, `/tmp/surface-linux`) and use plain `-a /tmp/local-repo` etc.\n\nWhen Anaconda boots from this ISO, it mounts the ISO filesystem at `/run/install/isodir/`. Therefore:\n- The local repo is at `file:///run/install/isodir/local-repo` (used in kickstart `repo` directive)\n- Assets are at `/run/install/isodir/iso-assets/` (used in `%post --nochroot`)\n\n### Credential handling\n\nThe build script accepts credentials via three methods (priority order):\n1. `--password-hash-file=PATH` \u2014 reads hash from file (recommended, avoids shell history)\n2. `ISO_PASSWORD_HASH` environment variable \u2014 useful for CI\n3. `--password-hash=HASH` \u2014 direct CLI (convenience, but leaks to shell history)\n\nUsername is provided via `--username=NAME` (not sensitive).\n\nThe ISO kickstart template has `@@USERNAME@@` and `@@PASSWORD_HASH@@` placeholders (distinct from the existing kickstart's `CHANGEME_*` pattern). The build script substitutes these before passing to mkksiso. The resulting ISO has credentials baked in \u2014 acceptable for personal use (single device, single user).\n\nFor GitHub Actions: CI runs validation/dry-run with dummy credentials. The build script MUST NOT log password hashes in any output.\n\n**Security note:** ISOs built with real credentials should never be uploaded to public GitHub Releases. CI builds always use `--test` mode with dummy credentials.\n\n### Package list single source of truth\n\nTo avoid drift between `lib/03-packages.sh` and the ISO kickstart's `%packages`, the build script extracts the package list from the existing lib files at build time. Pattern:\n- Parse `lib/03-packages.sh` for the `pkgs=()` array\n- Parse `lib/02-kernel.sh` for kernel packages\n- Parse `lib/01-repos.sh` for COPR list\n- Generate the kickstart `%packages` section dynamically\n\n### Offline repo construction\n\nIn the build container (Fedora 43):\n1. Install `dnf5-plugins` (for copr + config-manager subcommands)\n2. Enable 3 COPRs + linux-surface repo\n3. Expand `@^minimal-environment` group to individual package names:\n   ```\n   dnf5 group info '@^minimal-environment' --quiet \u2192 parse mandatory/default package names\n   ```\n4. `dnf5 download --resolve --destdir=/build/.cache/rpms --arch=x86_64 --arch=noarch <all-packages>`\n5. `createrepo_c /build/.cache/rpms`\n6. **Validate with repoclosure**: verify the local repo alone can satisfy the *expanded package set* (individual packages from `@^minimal-environment` expansion + explicit packages) without external repos. Use expanded package names, not the group token, since the local repo has no comps.xml group metadata\n\n**Critical constraints:**\n- The Containerfile MUST NOT install any target runtime packages; only build tools (lorax, createrepo_c, dnf5-plugins, git, jq, xorriso, isomd5sum). Installing target packages would cause `dnf5 download --resolve` to miss their transitive dependencies.\n- Cache paths use the workspace mount (`/build/.cache/`) not container `/tmp/`, so GitHub Actions can cache them between runs.\n\n### %post structure (ISO kickstart)\n\nAll `%post` logic uses the baked-in `@@USERNAME@@` placeholder (substituted at ISO build time). There is no runtime discovery of the username \u2014 the model is purely static.\n\n```\n%post --nochroot --log=/mnt/sysroot/var/log/ks-nochroot.log\n# Copy surface-linux repo from ISO to installed system\n# Copy pre-downloaded binaries to ~/.local/bin/ (matching lib/04-binaries.sh versions)\n# Copy pre-downloaded fonts to ~/.local/share/fonts/JetBrainsMono/ (matching lib/05-fonts.sh layout + .nf-version)\n# Copy pre-cloned lazy.nvim to ~/.local/share/nvim/lazy/lazy.nvim/\n# Set ownership to target user\n# Run: chroot /mnt/sysroot fc-cache -f (rebuild font cache)\n%end\n\n%post --log=/var/log/ks-post.log\n# Set HOME=/home/@@USERNAME@@, REPO_DIR=$HOME/surface-linux\n# Write zram config (from lib/06-zram.sh pattern)\n# Write iwd backend config (from lib/07-network.sh pattern)\n# Write getty auto-login override (from lib/08-desktop.sh pattern)\n# Write XDG portal config, UWSM env, systemd user env\n# Create dotfile symlinks (from lib/11-dotfiles.sh pattern)\n# Deploy helper scripts, wallpapers, .Xresources\n# Append bashrc.d sourcing + UWSM auto-start to shell profiles\n# Set graphical.target as default (matches lib/12-services.sh)\n# Set plymouth spinner theme (without -R)\n# Fix ownership of all $HOME content\n%end\n```\n\nService enabling uses kickstart's `services` directive with canonical unit names:\n```\nservices --enabled=NetworkManager,iwd,bluetooth,tuned\n```\n\nNote: `tuned-ppd` is a package (extends tuned's powerprofilesctl interface), NOT a service unit. It is included in `%packages` but not in `services --enabled`.\n\nThe `%post` and `services` directive MUST fully mirror the behavior of `lib/12-services.sh` \u2014 enabling the same units and setting the same default target. Any differences should be deliberate and documented.\n\n### Risks\n\n| Risk | Likelihood | Mitigation |\n|------|-----------|------------|\n| mkksiso can't handle 500 MB+ local repo addition | Low | mkksiso uses xorriso internally; handles large files. Fallback: manual xorriso ISO remaster |\n| Package dependency incomplete (dnf5 download misses transitive deps) | Medium | Run download in minimal container (no target packages installed). Validate with repoclosure in CI |\n| ISO exceeds 2 GiB (GitHub Release limit) | Low | boot.iso (800 MB) + packages (~700 MB) + assets (~50 MB) \u2248 1.5 GB. Use `%packages --excludedocs --excludeWeakdeps` |\n| COPR package ABI mismatch at download time | Low | Download all COPR packages atomically. Accept that COPR maintainer could push partial update |\n| Anaconda can't find embedded repo | Medium | Use `inst.ks=cdrom:/ks.cfg` + `repo --baseurl=file:///run/install/isodir/local-repo`. Test in QEMU first |\n| mkksiso-modified ISO doesn't boot via Ventoy | Low | Test on actual Ventoy USB. Fallback: dd directly to USB, skip Ventoy |\n| Build fails on GitHub Actions (disk space) | Medium | Use `jlumbroso/free-disk-space` action first. Monitor disk usage in workflow |\n| Config drift between ISO and install.sh paths | Medium | %post mirrors exact behavior of lib/*.sh stages. Acceptance criteria require parity |\n\n### Test notes\n\n- **Local build test:** Run `./iso/build-iso.sh` in Podman on macOS (Apple Silicon with `--platform linux/amd64`). Verify ISO is produced.\n- **Repoclosure test:** Validate the offline repo can satisfy all packages in an isolated container (no external repos). Run automatically in `--validate-only` mode.\n- **QEMU smoke test:** Boot the ISO in QEMU with `-m 4096 -drive file=test.qcow2,format=qcow2` and verify Anaconda starts, finds embedded repo, begins installation.\n- **Real hardware test:** Flash ISO to USB, boot Surface Go 3, verify full offline install produces working Hyprland desktop.\n- **Idempotency test:** After ISO install, verify `./install.sh` can still run without errors (converges to same state). Specifically: `./install.sh --only fonts`, `--only binaries`, `--only dotfiles` must be idempotent with pre-seeded assets.\n- **CI validation:** GitHub Actions builds ISO with dummy credentials, validates repo completeness, uploads as artifact.\n\n## Quick commands\n\n```bash\n# Build the ISO locally (requires Podman)\n# Generate password hash first:\nopenssl passwd -6 > /tmp/hash.txt\n./iso/build-iso.sh --username=edu --password-hash-file=/tmp/hash.txt\n\n# Build with default test credentials (for development)\n./iso/build-iso.sh --test\n\n# Validate ISO build + repo completeness in CI (no credentials, no mkksiso)\n./iso/build-iso.sh --validate-only\n\n# Flash ISO to USB\nsudo dd if=output/surface-linux-F43-*.iso of=/dev/sdX bs=4M status=progress\n\n# After ISO install, verify install.sh still works\n./install.sh --list\n./install.sh --only theme\n```\n\n## Acceptance\n\n- [ ] `./iso/build-iso.sh --username=X --password-hash-file=Y` produces a bootable ISO from Fedora boot.iso\n- [ ] ISO contains embedded local repo with all packages (official + COPR + linux-surface)\n- [ ] Offline repo passes repoclosure: can satisfy all `%packages` + `@^minimal-environment` without external repos\n- [ ] ISO contains pre-downloaded binaries (impala, bluetui, starship), fonts (JetBrains Mono NF), lazy.nvim\n- [ ] Binary versions and font layout match `lib/04-binaries.sh` and `lib/05-fonts.sh` exactly\n- [ ] Anaconda installs fully offline from embedded repo (no network activity during install)\n- [ ] %post configures: zram, iwd backend, getty auto-login, XDG portals, UWSM env, dotfiles, services\n- [ ] %post service configuration matches `lib/12-services.sh` behavior (same enabled units, same default target)\n- [ ] After reboot: Hyprland starts via UWSM with Tokyo Night theme, all tools functional\n- [ ] Existing `install.sh` works unchanged after ISO-based install (including `--only fonts`, `--only binaries`)\n- [ ] GitHub Actions workflow validates ISO build + repo completeness on every push/PR\n- [ ] ISO size < 2 GiB (fits GitHub Release asset limit)\n- [ ] README documents both install paths (manual kickstart vs. custom ISO)\n- [ ] Build script never logs password hashes; supports file/env input methods\n\n## References\n\n- [Omarchy ISO builder](https://github.com/omacom-io/omarchy-iso) \u2014 Arch Linux equivalent, architecture inspiration\n- [mkksiso documentation](https://weldr.io/lorax/mkksiso.html) \u2014 Embed kickstart + files into existing Fedora ISO\n- [livemedia-creator docs](https://weldr.io/lorax/livemedia-creator.html) \u2014 Fallback if mkksiso insufficient\n- [voor/fedora-offline-kickstart-spin](https://github.com/voor/fedora-offline-kickstart-spin) \u2014 Example offline Fedora ISO project\n- [Pykickstart reference](https://pykickstart.readthedocs.io/en/latest/kickstart-docs.html) \u2014 Kickstart syntax\n- [Anaconda boot options](https://anaconda-installer.readthedocs.io/en/latest/user-guide/boot-options.html) \u2014 inst.repo, inst.ks paths\n- [Project Issue #14](ISSUES.md) \u2014 Why %pre interactive prompts fail\n- [jlumbroso/free-disk-space](https://github.com/jlumbroso/free-disk-space) \u2014 GitHub Actions disk space recovery\n"
  },
  "epic_id": "fn-2-custom-offline-fedora-43-iso-builder",
  "schema_version": 2,
  "tasks": [
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-16T08:56:34.785257Z",
        "depends_on": [],
        "epic": "fn-2-custom-offline-fedora-43-iso-builder",
        "id": "fn-2-custom-offline-fedora-43-iso-builder.1",
        "priority": null,
        "spec_path": ".flow/tasks/fn-2-custom-offline-fedora-43-iso-builder.1.md",
        "status": "todo",
        "title": "Create ISO build script and Containerfile",
        "updated_at": "2026-02-16T09:12:40.451135Z"
      },
      "id": "fn-2-custom-offline-fedora-43-iso-builder.1",
      "runtime": null,
      "spec": "## Description\n\nCreate the ISO build pipeline: a Containerfile for the Fedora 43 build environment and a `build-iso.sh` orchestrator script that produces a self-contained, offline-installable ISO.\n\n**Size:** M\n**Files:** `iso/build-iso.sh`, `iso/Containerfile`\n\n## Approach\n\n### Containerfile (`iso/Containerfile`)\n- Base: `registry.fedoraproject.org/fedora:43`\n- Install **ONLY build tools**: `lorax` (provides mkksiso), `createrepo_c`, `dnf5-plugins`, `git`, `jq`, `xorriso`, `isomd5sum`\n- Enable 3 COPRs: `sdegler/hyprland`, `scottames/ghostty`, `alternateved/tofi`\n- Add linux-surface repo via `dnf5 config-manager addrepo --from-repofile=https://pkg.surfacelinux.com/fedora/linux-surface.repo`\n- **FORBIDDEN**: The Containerfile must NOT install any target runtime packages (hyprland, ghostty, kernel-surface, etc.). Only build tools are allowed. Installing target packages would cause `dnf5 download --resolve` to miss their transitive dependencies.\n- Workdir: `/build`\n\n### build-iso.sh (`iso/build-iso.sh`)\nFollow the project's shell conventions from `lib/00-common.sh:1-11`: `set -Eeuo pipefail`, `shopt -s inherit_errexit`, color logging helpers.\n\n**Credential input (priority order):**\n1. `--password-hash-file=PATH` \u2014 reads hash from file (recommended, avoids shell history)\n2. `ISO_PASSWORD_HASH` environment variable \u2014 useful for CI\n3. `--password-hash=HASH` \u2014 direct CLI (convenience, leaks to shell history \u2014 warn in help text)\n\n**Other arguments:**\n- `--username=NAME` (required unless `--test` or `--validate-only`)\n- `--test` \u2014 use dummy credentials for dev builds\n- `--validate-only` \u2014 dry run: downloads + repo creation + repoclosure check, but skips mkksiso\n- `--boot-iso=PATH` \u2014 path to Fedora boot.iso (auto-downloads if not provided)\n- `--output-dir=PATH` \u2014 output directory (default: `./output/`)\n\n**The script MUST NOT log password hashes in any output** (no `set -x` over credential handling, no echoing hash values).\n\n**Cache paths:** All downloads use workspace-relative `.cache/` directory (not container `/tmp/`), so GitHub Actions can cache between runs:\n- RPMs: `/build/.cache/rpms` (where `/build` is the workspace mount)\n- Boot ISO: `/build/.cache/isos/fedora-boot-43.iso`\n- Assets: `/build/.cache/assets/`\n\n**Stages (in order):**\n\n1. **Download Fedora boot.iso** \u2014 if not provided via `--boot-iso` and not cached in `.cache/isos/`, download from Fedora mirrors. Verify SHA256 checksum.\n\n2. **Expand @^minimal-environment** \u2014 extract individual package names from the group:\n   ```\n   dnf5 group info '@^minimal-environment' --quiet \u2192 parse mandatory/default package names\n   ```\n   This avoids relying on `dnf5 download` group support (historically fragile).\n\n3. **Download all RPMs** \u2014 Extract package list from `lib/03-packages.sh` (the `pkgs=()` array), `lib/02-kernel.sh` (kernel-surface, libwacom-surface), combine with expanded minimal-environment packages. Run `dnf5 download --resolve --destdir=/build/.cache/rpms --arch=x86_64 --arch=noarch <all-packages>`. This MUST run inside the container (minimal env with no target packages) to capture all transitive deps.\n\n4. **Create local repo** \u2014 Run `createrepo_c /build/.cache/rpms`. This generates the repodata Anaconda needs.\n\n5. **Validate repo (repoclosure)** \u2014 Verify the local repo can satisfy ALL packages + `@^minimal-environment` without external repos. Run in an isolated context with only the local repo enabled:\n   ```\n   dnf5 \\\n     --setopt=reposdir=/dev/null \\\n     --setopt=local-only.name=local-only \\\n     --setopt=local-only.baseurl=file:///build/.cache/rpms \\\n     --setopt=local-only.enabled=1 \\\n     install --assumeno --repo=local-only \\\n       \"${minimal_env_pkgs[@]}\" \"${all_pkgs[@]}\"\n   ```\n   Where `minimal_env_pkgs[@]` is the expanded package list from Stage 2 and `all_pkgs[@]` is from `lib/03-packages.sh` + `lib/02-kernel.sh`. Use expanded package names, NOT the `@^minimal-environment` group token \u2014 the local repo has no comps.xml group metadata. This explicit `--setopt` pattern configures a temporary repo pointing only at the local cache, with no external repos (`reposdir=/dev/null`). This MUST pass before proceeding to ISO assembly. Runs in both `--validate-only` and full build modes. CI and local runs use the identical pattern.\n\n6. **Download binaries** \u2014 Following URL patterns from `lib/04-binaries.sh:68-87`: download impala, bluetui, starship for x86_64. **Must use the same version constants** as `lib/04-binaries.sh` (impala_version, bluetui_version, starship_version). Place in `/build/.cache/assets/binaries/`.\n\n7. **Download fonts** \u2014 Following pattern from `lib/05-fonts.sh:10-11`: download JetBrains Mono Nerd Font tar.xz. **Must use the same version constant** as `lib/05-fonts.sh`. Extract to `/build/.cache/assets/fonts/JetBrainsMono/`. Write `.nf-version` file matching `lib/05-fonts.sh` layout.\n\n8. **Pre-clone lazy.nvim** \u2014 `git clone --filter=blob:none --branch=stable https://github.com/folke/lazy.nvim.git /build/.cache/assets/lazy-nvim/`\n\n9. **Copy surface-linux repo** \u2014 Copy the repo (from the build context mount) to staging directory. Generate theme files using existing template engine logic (process `colors.toml` + `templates/*.tpl` \u2192 `config/` output files). These are .gitignored so must be generated at build time.\n\n10. **Substitute credentials** \u2014 Copy `iso/surface-go3-iso.ks` to temp, substitute `@@USERNAME@@` and `@@PASSWORD_HASH@@` placeholders with provided values.\n\n11. **Assemble ISO** \u2014 Run mkksiso with explicit path mapping:\n    ```\n    mkksiso --ks /tmp/kickstart.ks \\\n      -a /build/.cache/rpms:/local-repo \\\n      -a /build/.cache/assets:/iso-assets \\\n      -a /tmp/surface-linux:/surface-linux \\\n      -c \"inst.ks=cdrom:/ks.cfg\" \\\n      -V \"SurfaceLinux-43\" \\\n      /build/.cache/isos/fedora-boot-43.iso \\\n      /build/output/surface-linux-F43-$(date +%Y%m%d)-x86_64.iso\n    ```\n    Note: `inst.ks=cdrom:/ks.cfg` is the correct Anaconda form (NOT `file:///`). Must run as root (mkksiso requirement since lorax 38.4).\n\n    After mkksiso, the in-ISO layout is:\n    - `/ks.cfg` \u2014 kickstart (auto-loaded via `inst.ks=cdrom:/ks.cfg`)\n    - `/local-repo/` \u2014 offline RPM repo (referenced by kickstart `repo --baseurl=file:///run/install/isodir/local-repo`)\n    - `/iso-assets/` \u2014 binaries, fonts, lazy.nvim\n    - `/surface-linux/` \u2014 the dotfiles repo with generated theme files\n\n**Package extraction from lib/*.sh:**\nParse `lib/03-packages.sh` to extract the `pkgs=()` array contents. Use grep/sed to extract package names. This avoids duplicating the package list \u2014 `lib/03-packages.sh` remains the single source of truth.\n\n## Key context\n\n- `mkksiso` must run as root (lorax 38.4+). The container runs as root by default.\n- `mkksiso -a SRC:DEST` maps source directories to specific ISO root paths. If mkksiso on Fedora 43 does not support `:DEST` syntax, use a fallback: copy directories to temp paths with the desired names (`/tmp/local-repo`, `/tmp/iso-assets`, `/tmp/surface-linux`) and use plain `-a` flags.\n- `dnf5 download --resolve` uses `--destdir` (NOT `--downloaddir`, removed in dnf5). Include `--arch=noarch` alongside `--arch=x86_64`.\n- `createrepo_c` generates yum-compatible repo metadata that Anaconda expects.\n- Theme engine outputs are `.gitignored` (`.gitignore:5-11`). They MUST be generated during build.\n- Shell conventions: `set -Eeuo pipefail`, `shopt -s inherit_errexit`, `readonly` for constants, `info()`/`warn()`/`error()` color helpers.\n- Cache directory pattern: `/build/.cache/` maps to `${REPO_ROOT}/.cache/` on host, enabling GitHub Actions caching.\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-16T08:56:42.209125Z",
        "depends_on": [
          "fn-2-custom-offline-fedora-43-iso-builder.1"
        ],
        "epic": "fn-2-custom-offline-fedora-43-iso-builder",
        "id": "fn-2-custom-offline-fedora-43-iso-builder.2",
        "priority": null,
        "spec_path": ".flow/tasks/fn-2-custom-offline-fedora-43-iso-builder.2.md",
        "status": "todo",
        "title": "Create ISO kickstart with embedded repo and %post config",
        "updated_at": "2026-02-16T09:12:10.172771Z"
      },
      "id": "fn-2-custom-offline-fedora-43-iso-builder.2",
      "runtime": null,
      "spec": "## Description\n\nCreate the ISO-specific kickstart file that works with the embedded local repo and runs all configuration stages in %post. This kickstart is a SEPARATE file from the existing `kickstart/surface-go3.ks` \u2014 it's purpose-built for the custom ISO install path.\n\n**Size:** M\n**Files:** `iso/surface-go3-iso.ks`\n\n## Approach\n\n### Kickstart structure\n\nThe kickstart has 5 sections: header, %packages, %post --nochroot, %post (chroot), and the `services` directive.\n\n**Header:**\n- Text mode (`text`)\n- Same locale/keyboard/timezone as existing kickstart (`kickstart/surface-go3.ks:23-31`)\n- Same disk config: `ignoredisk --only-use=mmcblk0`, `clearpart --all --initlabel --disklabel=gpt`, `reqpart --add-boot`, `part / --fstype=ext4 --grow`\n- `rootpw --lock`\n- `firewall --enabled --service=mdns`\n- `selinux --enforcing`\n- `user --name=@@USERNAME@@ --groups=wheel --password=@@PASSWORD_HASH@@ --iscrypted`\n- `network --bootproto=dhcp --device=link --activate` (kept for optional post-install connectivity; Anaconda won't stall \u2014 offline install still works)\n- `repo --name=surface-local --baseurl=file:///run/install/isodir/local-repo --cost=10` \u2014 points to the embedded local repo added by mkksiso. The ISO mounts at `/run/install/isodir/`.\n- `services --enabled=NetworkManager,iwd,bluetooth,tuned` \u2014 canonical systemd unit names only. Note: `tuned-ppd` is a PACKAGE (extends tuned), NOT a service unit \u2014 it is included in `%packages` only.\n- `shutdown` (for first testing; change to `reboot` once validated)\n\n**%packages:**\n- `--excludeWeakdeps --excludedocs` for size optimization\n- `@^minimal-environment`\n- ALL packages from `lib/03-packages.sh` (the full list \u2014 hyprland, ghostty, tofi, etc.)\n- ALL packages from `lib/02-kernel.sh` (kernel-surface, libwacom-surface)\n- `dnf5-plugins` (needed for post-install COPR management)\n- `tuned-ppd` (the package, for powerprofilesctl support)\n- Explicit excludes: `-kernel` (replaced by kernel-surface)\n\n**%post --nochroot** (installer environment, installed system at `/mnt/sysroot/`):\n- Set `USERNAME=@@USERNAME@@` (static, baked in at build time \u2014 no runtime discovery)\n- Copy surface-linux repo from ISO: `cp -a /run/install/isodir/surface-linux /mnt/sysroot/home/$USERNAME/`\n- Copy pre-downloaded binaries to `/mnt/sysroot/home/$USERNAME/.local/bin/` \u2014 these MUST match the exact versions from `lib/04-binaries.sh` so that re-running `./install.sh --only binaries` is idempotent\n- Copy pre-downloaded fonts to `/mnt/sysroot/home/$USERNAME/.local/share/fonts/JetBrainsMono/` \u2014 reproduce `lib/05-fonts.sh` directory structure including `.nf-version` file\n- Copy pre-cloned lazy.nvim to `/mnt/sysroot/home/$USERNAME/.local/share/nvim/lazy/lazy.nvim/`\n- Set ownership: `chown -R` all copied files to target user\n- Run `chroot /mnt/sysroot fc-cache -f` to rebuild font cache\n\n**%post** (chroot, runs as root inside installed system):\n- Set `HOME=/home/@@USERNAME@@`, `REPO_DIR=$HOME/surface-linux` \u2014 all `%post` logic uses the baked-in `@@USERNAME@@` placeholder. There is NO runtime discovery of the username.\n- **zram** (from `lib/06-zram.sh:15-35` pattern): write `/etc/systemd/zram-generator.conf` + `/etc/sysctl.d/99-zram.conf`\n- **network** (from `lib/07-network.sh:26-28` pattern): write `/etc/NetworkManager/conf.d/wifi-backend.conf`\n- **desktop** (from `lib/08-desktop.sh` pattern):\n  - Getty auto-login override at `/etc/systemd/system/getty@tty1.service.d/override.conf` \u2014 use single-quoted heredoc, `@@USERNAME@@` already substituted by build script\n  - XDG portal config at `$HOME/.config/xdg-desktop-portal/portals.conf`\n  - UWSM env files at `$HOME/.config/uwsm/env` and `$HOME/.config/uwsm/env-hyprland`\n  - Systemd user env at `$HOME/.config/environment.d/surface-linux.conf`\n- **dotfiles** (from `lib/11-dotfiles.sh` pattern):\n  - Symlink config dirs: `ln -snfT $REPO_DIR/config/<dir> $HOME/.config/<dir>` for each of: hypr, waybar, mako, ghostty, tofi, nvim, bashrc.d, gtk-3.0, gtk-4.0, starship\n  - Symlink local-bin scripts\n  - Copy wallpapers to `$HOME/.local/share/wallpapers/surface-linux/`\n  - Write `$HOME/.Xresources` with `Xft.dpi: 144`\n  - Append bashrc.d sourcing loop to `$HOME/.bashrc` (from `lib/11-dotfiles.sh:160-174`)\n  - Append UWSM auto-start to `$HOME/.bash_profile` (from `lib/11-dotfiles.sh:187-196`)\n- **services**: `systemctl set-default graphical.target` (matches `lib/12-services.sh` behavior)\n- **plymouth**: set spinner theme via `plymouth-set-default-theme spinner` (without `-R` \u2014 Anaconda handles initrd)\n- **repos for post-install updates**: Configure COPR repos and linux-surface repo on the installed system so `dnf update` works once WiFi is connected. Follow patterns from `lib/01-repos.sh:29-45`.\n- Fix ownership: `chown -R @@USERNAME@@:@@USERNAME@@ $HOME/`\n\n**Parity requirement:** The `%post` configuration and `services` directive MUST fully mirror the behavior of `lib/12-services.sh` \u2014 enabling the same units and setting the same defaults. Any differences must be deliberate and documented. If `lib/12-services.sh` enables a unit, the ISO kickstart must enable it too (either via `services --enabled=` or `systemctl enable` in `%post`).\n\n## Key context\n\n- `%post --nochroot` sees installed system at `/mnt/sysroot/` (Fedora 43 Anaconda). NOT `/mnt/sysimage/` (older docs).\n- `%post` (default, chroot) runs as root inside installed system. `$HOME` is `/root` unless explicitly set \u2014 MUST set `HOME=/home/@@USERNAME@@`.\n- `systemctl enable` works in chroot (creates symlinks). But prefer kickstart `services --enabled=` directive.\n- `systemctl daemon-reload` does NOT work in chroot. Not needed \u2014 next boot picks up config.\n- Theme files are already generated by the build script (task .1) and included in the surface-linux repo copy. No template processing needed in %post.\n- `plymouth-set-default-theme spinner -R` rebuilds initramfs. Use without `-R` in %post \u2014 Anaconda generates the initrd.\n- `@@USERNAME@@` and `@@PASSWORD_HASH@@` are build-time substitution placeholders (distinct from existing kickstart's `CHANGEME_*` pattern).\n- Kickstart `services` directive: comma-separated, NO spaces between service names. Use canonical systemd unit names only.\n- `tuned-ppd` is a package, not a service unit. Include in `%packages`, not in `services --enabled=`.\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-16T08:56:48.005446Z",
        "depends_on": [
          "fn-2-custom-offline-fedora-43-iso-builder.1",
          "fn-2-custom-offline-fedora-43-iso-builder.2"
        ],
        "epic": "fn-2-custom-offline-fedora-43-iso-builder",
        "id": "fn-2-custom-offline-fedora-43-iso-builder.3",
        "priority": null,
        "spec_path": ".flow/tasks/fn-2-custom-offline-fedora-43-iso-builder.3.md",
        "status": "todo",
        "title": "Add GitHub Actions workflow for ISO builds",
        "updated_at": "2026-02-16T09:12:11.303459Z"
      },
      "id": "fn-2-custom-offline-fedora-43-iso-builder.3",
      "runtime": null,
      "spec": "## Description\n\nAdd a GitHub Actions workflow that validates the ISO build pipeline on every push/PR and optionally produces a downloadable ISO artifact via manual dispatch.\n\n**Size:** M\n**Files:** `.github/workflows/build-iso.yml`\n\n## Approach\n\n### Workflow triggers\n- `push` to main branch (paths: `iso/**`, `lib/**`, `kickstart/**`, `config/**`, `templates/**`, `colors.toml`)\n- `pull_request` (same paths)\n- `workflow_dispatch` with inputs:\n  - `upload_artifact` (boolean, default: false) \u2014 upload ISO as workflow artifact\n  - `create_release` (boolean, default: false) \u2014 create GitHub Release with ISO\n\n### Job: `build-iso`\n\n**Runner:** `ubuntu-latest`\n\n**Steps:**\n\n1. **Free disk space** \u2014 Use `jlumbroso/free-disk-space@v1.3.1` to reclaim ~30 GB. Settings: `android: true`, `dotnet: true`, `haskell: true`, `large-packages: true`, `docker-images: true`, `tool-cache: false`, `swap-storage: true`. This MUST run BEFORE checkout.\n\n2. **Checkout** \u2014 `actions/checkout@v4`\n\n3. **Cache RPM repo** \u2014 `actions/cache@v4` with:\n   - `path: .cache/rpms`\n   - `key: fedora43-rpms-${{ hashFiles('lib/03-packages.sh', 'lib/02-kernel.sh') }}`\n   This avoids re-downloading 500+ MB of RPMs when package lists haven't changed.\n\n4. **Cache boot ISO** \u2014 `actions/cache@v4` with:\n   - `path: .cache/isos`\n   - `key: fedora43-boot-iso`\n\n5. **Install Podman** \u2014 Standard ubuntu-latest has Podman. Verify version, install latest if needed.\n\n6. **Build container** \u2014 `sudo podman build -t surface-iso-builder iso/`\n\n7. **Run build (validate mode)** \u2014 For push/PR: `sudo podman run --privileged --rm -v ${{ github.workspace }}:/build surface-iso-builder /build/iso/build-iso.sh --test --validate-only`. This validates package download, repo creation, repoclosure check, asset download, but skips mkksiso assembly. Note: NO `:Z` suffix on volume mount (not needed on ubuntu-latest, causes warnings).\n\n8. **Run build (full, on dispatch)** \u2014 When `workflow_dispatch` with `upload_artifact=true`: run full build with `--test` credentials. Produces actual ISO.\n\n9. **Report disk usage** \u2014 `df -h` after build to monitor space consumption.\n\n10. **Upload artifact** \u2014 Conditional on dispatch input. Use `actions/upload-artifact@v4` with `compression-level: 0` (ISO is already compressed), `retention-days: 7`.\n\n11. **Create release** \u2014 Conditional on dispatch input. Use `softprops/action-gh-release@v2` with tag from run number or date. Generate SHA256 checksum alongside ISO.\n\n### Repoclosure validation in CI\n\nThe validate-only mode MUST include an automated correctness check (from task .1's `--validate-only` behavior):\n- Spin up a nested container with only the local repo\n- Verify `dnf5 install --assumeno` can resolve ALL packages + `@^minimal-environment` without external repos\n- This goes beyond \"dnf5 download succeeded\" \u2014 it proves the repo is self-contained\n\n### Permissions\n```yaml\npermissions:\n  contents: write  # needed for release creation\n```\n\n### Caching strategy\n\nCache paths match the build script's `.cache/` directory structure:\n- `.cache/rpms/` \u2014 local RPM repo (500 MB+, key changes when package lists change)\n- `.cache/isos/` \u2014 Fedora boot.iso (~800 MB, rarely changes)\n\nThese paths are in the workspace mount (not container `/tmp/`), so GitHub Actions can see and cache them.\n\n## Key context\n\n- Podman on ubuntu-latest: use `sudo podman` (rootful) for `--privileged` support.\n- Do NOT use `:Z` SELinux volume suffix on ubuntu-latest (not an SELinux host, may cause warnings).\n- `jlumbroso/free-disk-space` must run early to reclaim ~30 GB on the 14 GB default runner.\n- GitHub Release assets max 2 GiB per file. ISO target is ~1.5 GB.\n- `actions/upload-artifact@v4`: `compression-level: 0` is critical for ISOs (already compressed).\n- Do NOT use GitHub Actions `container:` directive for Podman. Use explicit `podman run` in `run:` steps.\n- Workflow should NOT embed real credentials. Always use `--test` for CI builds.\n- CI builds with real credentials should only happen via workflow_dispatch with repository secrets.\n"
    },
    {
      "data": {
        "assignee": null,
        "claim_note": "",
        "claimed_at": null,
        "created_at": "2026-02-16T08:56:55.107162Z",
        "depends_on": [
          "fn-2-custom-offline-fedora-43-iso-builder.1",
          "fn-2-custom-offline-fedora-43-iso-builder.2"
        ],
        "epic": "fn-2-custom-offline-fedora-43-iso-builder",
        "id": "fn-2-custom-offline-fedora-43-iso-builder.4",
        "priority": null,
        "spec_path": ".flow/tasks/fn-2-custom-offline-fedora-43-iso-builder.4.md",
        "status": "todo",
        "title": "Update documentation for dual install paths",
        "updated_at": "2026-02-16T09:12:12.278723Z"
      },
      "id": "fn-2-custom-offline-fedora-43-iso-builder.4",
      "runtime": null,
      "spec": "## Description\n\nUpdate README.md to document the new custom ISO install path alongside the existing manual kickstart path. Create `iso/README.md` with build/development documentation.\n\n**Size:** M\n**Files:** `README.md`, `iso/README.md`\n\n## Approach\n\n### README.md restructuring\n\nAdd a new section near the top (after \"Hardware Target\") that presents two installation paths:\n\n**New section: \"Installation\"**\n- Brief comparison table: Path A (Manual) vs Path B (Custom ISO)\n- Path A: current flow (download Everything ISO, edit kickstart, OEMDRV, boot, then run install.sh)\n- Path B: new flow (build or download custom ISO, flash to USB, boot, done)\n- Link to detailed steps for each\n\n**Restructure existing sections:**\n- Move current \"USB Preparation\" through \"Post-Install\" under a \"Path A: Manual Installation\" subsection\n- Add \"Path B: Custom ISO Installation\" subsection with:\n  - Prerequisites (Podman for building, or download from GitHub Releases)\n  - How to build the ISO locally (with credential input methods)\n  - How to flash and boot\n  - What happens automatically (all stages run in kickstart %post)\n- Update \"Quick Reference\" to mention both paths\n\n**Preserve:**\n- All existing content (just reorganized, not deleted)\n- Hardware Target, Hardware Detection, Idempotency, Secure Boot, Log File, References sections (unchanged)\n- Stage table and dependency info (still applies to Path A and to `install.sh --only` reruns after ISO install)\n\n**Add notes:**\n- After ISO install, `install.sh` still works for re-running individual stages (`--only fonts`, `--only theme`, etc.)\n- First `nvim` launch needs WiFi for plugin sync\n- ISO credentials are baked in at build time (no runtime prompts) \u2014 recommend `--password-hash-file` for security\n\n### iso/README.md (new file)\n\nDeveloper documentation for the ISO build system:\n- Overview and architecture (reference epic spec diagram)\n- Prerequisites: Podman, ~5 GB disk space, network for package downloads\n- Credential input methods with clear matrix:\n\n  | Flags | Credentials used | mkksiso run? |\n  |-------|-----------------|--------------|\n  | `--username X --password-hash-file Y` | Real | Yes |\n  | `--test` | Dummy | Yes |\n  | `--validate-only` | Dummy or none | No |\n  | `--test --validate-only` | Dummy | No |\n\n- Password hash generation: `openssl passwd -6 > hash.txt`\n- How it works (step by step: expand groups, download packages, create repo, repoclosure, download assets, generate theme, mkksiso)\n- GitHub Actions: how CI validates builds (repoclosure check), how to trigger manual build + release\n- Customization: changing keyboard layout, timezone, adding packages\n- Troubleshooting: common build failures, disk space issues, COPR repo unavailability\n- How to test: QEMU smoke test command\n- Security: never upload ISOs with real credentials to public releases\n\n### Style guidelines\n- Follow existing README.md style: tables for hardware/stages, bash code blocks with comments, step numbers\n- Follow commit message convention: `docs(iso): ...` or `docs: ...`\n- Do NOT add emojis (not used in existing docs)\n\n## Key context\n\n- The existing README is 254 lines. Restructuring should keep it similar length (reorganize, don't bloat).\n- Commit message style from recent history: `fix(waybar):`, `docs: switch to OEMDRV`, `docs(issues):`.\n- The Stages table and dependencies section still applies \u2014 stages are what install.sh does, and after an ISO install the user can still run individual stages.\n- `kickstart/surface-go3.ks` inline comments should get a brief \"see also: `iso/surface-go3-iso.ks` for the custom ISO kickstart\" note.\n"
    }
  ]
}
